<div class="content">
  <!-- Card 1 -->
  <mat-card>
    <mat-card-header>
      <mat-card-title>
        Verbindung zu JAuswertung, um Startkarten zu laden
      </mat-card-title>
    </mat-card-header>

    <mat-card-content>
      <div class="grid-2">
        <div>
          <p class="muted"><b>Quelle</b>: {{ fullUrl() }}</p>
          <div class="help">Änderbar im Tab <b>Einstellungen</b>.</div>
        </div>

        <div>
          <div class="actions-right">
            <button mat-stroked-button color="primary" (click)="loadStartkarten()">
              Startkarten laden
            </button>
            <p>{{ statusText() }}</p>
          </div>
        </div>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Card Select run-->
  <mat-card>
    <mat-card-header>
      <mat-card-title>
        Lauf auswählen
      </mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <mat-form-field appearance="outline">
        <mat-label>Aktueller Lauf</mat-label>
        <mat-select [ngModel]="selectedLauf()" (ngModelChange)="selectedLauf.set($event)" name="laufSelect">
          @if (laufOptions().length === 0) {
            <mat-option disabled>Keine Läufe vorhanden</mat-option>
          }
          @for (opt of laufOptions(); track opt.value) {
            <mat-option [value]="opt.value">{{ opt.label }}</mat-option>
          }
        </mat-select>
      </mat-form-field>

      <button mat-raised-button color="primary" (click)="loadStartkarten()">
        Startkarten laden
      </button>

      <span>{{ statusText() }}</span>
    </mat-card-content>
  </mat-card>
  <div class="grid-mapping">
    <mat-card>
      <mat-card-header>
        <mat-card-title>
          Bahnen
        </mat-card-title>
      </mat-card-header>
      <mat-card-subtitle style="text-align: right; padding-right: 20px">{{ maxBahnenText() }}</mat-card-subtitle>

      <table mat-table [dataSource]="filteredBahnen()" class="mat-elevation-z2 w-100">
        <!-- Bahn Column -->
        <ng-container matColumnDef="bahn">
          <th mat-header-cell *matHeaderCellDef>Bahn</th>
          <td mat-cell *matCellDef="let row">{{ row.startcard.Bahn }}</td>
        </ng-container>

        <!-- Name Column -->
        <ng-container matColumnDef="name">
          <th mat-header-cell *matHeaderCellDef>Name</th>
          <td mat-cell *matCellDef="let row">{{ row.startcard.Vorname }} {{ row.startcard.Nachname }}</td>
        </ng-container>

        <!-- Startnr Column -->
        <ng-container matColumnDef="startnr">
          <th mat-header-cell *matHeaderCellDef>Startnr.</th>
          <td mat-cell *matCellDef="let row">{{ row.startcard.Startnummer }}</td>
        </ng-container>

        <!-- Disziplin Column -->
        <ng-container matColumnDef="disziplin">
          <th mat-header-cell *matHeaderCellDef>Disziplin</th>
          <td mat-cell *matCellDef="let row">{{ row.startcard.Disziplin }}</td>
        </ng-container>

        <ng-container matColumnDef="taster">
          <th mat-header-cell *matHeaderCellDef> Taster</th>
          <td mat-cell *matCellDef="let element">
            @if (element.assignedTaster) {
              <span class="taster-name-label">
                {{ (element.assignedTaster)?.name || 'Keinen Namen' }}
            </span>
            } @else {
              <span class="muted-text small italic">Kein Taster</span>
            }
          </td>
        </ng-container>

        <!-- Header definition -->
        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
      </table>


    </mat-card>

    <mat-card>
      <mat-card-header>
        <mat-card-title>Mapping</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
          <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 0.5rem;">

            <!-- List all Lanes from the mapping response -->
            <h3>Verfügbare Bahnen</h3>
            @let mappingData = tasterService.mappingResource.value();
            @if (mappingData) {
              @for (laneEntry of mappingData.mapping | keyvalue; track laneEntry.key) {
                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                  @let taster = laneEntry.value;
                  @if (taster) {
                    <app-taster-card
                      [title]="'Taster ' + taster?.name || 'Taster'"
                      [detail]="taster?.mac || 'Nicht belegt'"
                      [vitals]=undefined
                      [badgeText]="'BAHN ' + laneEntry.key + ' AKTIV'"
                      badgeVariant="active"
                      (click)="removeTasterFromLane(laneEntry.key.toString())">
                    </app-taster-card>
                  } @else {
                    <app-taster-card
                      [title]="'Bahn ' + laneEntry.key"
                      [detail]="'Nicht belegt'"
                      [badgeText]="selectedTasterForAssignment() ? 'HIERHER ZUWEISEN' : 'LEER'"
                      [badgeVariant]="selectedTasterForAssignment() ? 'default' : 'inactive'"
                      (click)="selectedTasterForAssignment() ? assignTaster(selectedTasterForAssignment()!, laneEntry.key.toString()) : null">
                    </app-taster-card>
                  }
                </div>
              }
            }
          </div>
          <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 0.5rem;">
            <h3>Verfügbare Taster</h3>
            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; flex-shrink: 0;">
              @for (taster of mappingData?.unmapped_taster; track taster.mac) {
                <app-taster-card
                  [title]="'Taster ' + taster?.name || 'Taster'"
                  [detail]="taster.mac"
                  [badgeText]="selectedTasterForAssignment() === taster.mac ? 'AUSGEWÄHLT' : 'BEREIT'"
                  [badgeVariant]="selectedTasterForAssignment() === taster.mac ? 'active' : 'default'"
                  (click)="selectedTasterForAssignment.set(taster.mac)">
                </app-taster-card>
              }
            </div>
          </div>
        </div>
      </mat-card-content>
    </mat-card>
  </div>
</div>
